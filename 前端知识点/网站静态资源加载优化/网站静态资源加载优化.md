# 网站静态资源优化 #

在平时工作中，经常会遇到这样一个问题，就是：为什么要把网站的静态资源，比如 img、css 或者 js 等放置在一个或者多个独立的域名之下。

比如有2个网站：www.a.com、www.b.com，它们里面有加载了同一个 js 资源文件 jquere.js，那么我们就可以把这个 js 文件都统一放置在 www.zy.com 域下（这个域下可能还有很多其他的资源文件）。

这样做主要目的是为了优化网站的加载速度，主要原因有以下几点：

1. 浏览器为提升页面显示效率，支持并发获取资源（**在同一时间，同时下载多个资源文件**）。浏览器对于并发的请求是由数量限制的（每个浏览器数量限制不一样）。这主要是为了优化下载速度，防止在同一域名下（包括二级域名），下载的线程过多，导致下载速度变慢，如果请求的并发数量超出了限制，则会产生阻塞问题，导致页面比较卡顿。基于这个原因，可将资源文件部署到不同的一级域名下，以达到最大化的并发下载。（这个是主要原因）

2. 假设网站 cookie 信息有 1KB，网站首页共 150 个资源时，用户在请求过程中需要发送 150KB的 cookie信息，在 512Kbps 的常见上行带宽下，需要长达3秒左右才能全部发送完毕。很多情况下 cookie 的 path 是在整个一级域名下可用的，如果你把静态资源设置成二级域名，那么它也避免不了cookie。例如如果给 http://126.com 设置了cookie,那么会感染所有子域名, 请求 http://www.126.com/logo.gif 或者 http://image.126.com/logo.gif 时便会带上讨厌的 cookie。<br>
所以对于静态资源使用单独的一级域名，并设置为无 cookie，以减少请求大小，提高网页性能。所以启用新的一级域名，每次请求浏览器都不会携带 cookie。这对于 cookie 内容比较大，并且流量大的网站会省去不少宽带费用。

3. 方便分流或缓存：动静分离。静态资源与动态内容分离，有利于部署于CDN。静态资源独立部署，为全局产品服务。方便复用，放在一个服务器上的文件可以共其他服务器上的产品使用。 比如taobao.com和tmll.com都会用到tbcdn.cn上的静态资源，这些资源不必从属于某个产品。<br>
这样同时也有利于最大化利用客户端缓存。比如访问taobao.com，缓存了tbcdn.cn上的某个js文件，之后再访问tmll.com时，也用到此js文件，不必再从tbcdn.cn上下载，直接用客户端缓存即可。


# 总结如下 #
1. 最大化浏览器并发下载静态资源，加快网页呈现速度
2. 请求静态资源时不用携带 cookie，节约宽带开销
3. 方便 CDN 部署，有利于浏览器缓存


# 前端静态文件如何应对 HTTPS 的到来？ #
现在越来越多的网站开始采用 https 协议，而在 https 协议下，对 http 有两个限制：

1、https 下不能直接拉取 http 的静态资源文件

浏览器默认是不允许在 HTTPS 里面引用 HTTP 资源的，一般都会弹出提示框，用户确认后才会继续加载，用户体验非常差。而且如果在一个 HTTPS 页面里动态的引入 HTTP 资源，比如引入一个 js 文件，会被直接忽略掉。Chrome21 之后，在 SSL 加密层处理后会被默默的屏蔽掉，只留下一句 console 报告。浏览器为了安全，https 下跨协议调用 http 的是不行的，控制台里会有警告。最好的方法是使用 https 的资源。


2、https 下不能调用 http 的异步请求

如果在 https 的页面中使用 http 的 ajax 调用。会提示跨域的报错，很明显有违ip地址、端口、协议的跨域限制。有两种方案：其一试调用 https 的 ajax，既然页面都升级到 https 了那么服务接口升级也是应该的。其二既然跨域了，我们可以考虑 jsonp 的方案，但是 jsonp 发出的是js文件请求。所以同上一个问题 https 中应用静态资源也必须是 https 的。所以即使是jsonp 的方式也要提供 jsonp 接口的服务器支持 https。

不过 a 标签是可以正常使用的，这个是题外话。

**前端应该如何应对？**

1、静态文件拉取：

首先要保证在https的页面中拉取http的静态资源。那么静态资源就必须支持https。这方面就要去抱运维大神们的大腿了，申请证书，配置到需要使用的服务器上（我们应该事先提供会用到哪些静态资源的域名）。
2、服务升级：

同样的拿到证书后，要保证 ajax 的接口支持 https。这样服务端的工作就支持的差不多了。

3、页面引用：

既然我们的静态文件支持了 http 和 https 两种协议。但是静态文件并不知道页面是什么协议。我们应该怎么适应呢？引用资源的url中我们应该使用相对协议，比如：
<pre>
src="http://a.com/static/a.js"
</pre>

应该改为如下：去掉http:

<pre>
src="//a.com/static/a.js"
</pre>

以“//”开头表示相对协议，页面使用的是什么协议，文件请求也自动是什么协议。同样的异步请求也应该这样适应。